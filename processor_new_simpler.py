import tables as t, pylab as py, pandas as pd, os, queue as Queue, numpy as np
import sys
import shutil
import matplotlib.dates as mdates
from statistics import mean
from scipy.optimize import curve_fit
import os
import glob
import matplotlib.pyplot as plt


#ARGUMENTS:
# sys.argv[1] = fill number
# sys.argv[2] = channel number

print ("Fill  " + sys.argv[1])
print ("Channel  " , str(sys.argv[2]))
fill = int(sys.argv[1])
channel = int(sys.argv[2])

if fill<5633:
	    raise ValueError('Fill number too small, this script only works with 2017 and 2018 data')
elif fill<6540:
	    year = 17
elif fill<7920:
	    year = 18
elif fill<8533:
	    year = 22
else:
	    year = 23

#NEW CORRECTION

eb_num =  1 #number of the empty bunch that you want to analyze (first, second, ...)




fills_non_corrected = []
fills_corrected = []

    
folder_reprocessed = glob.glob('Channel_'+str(channel)+'_'+str(year)+'_old/'+str(fill)+"/")



print(folder_reprocessed)
for fill_num in folder_reprocessed:
    files = dir_list = os.listdir(str(fill_num))
    print("Fill" + fill_num) 
    bxraw_reprocessed = []
    for file in files:
        print("File" + file)
        h5 = t.open_file(fill_num+'/'+file)
        for row in h5.root.bcm1flumi.iterrows():
            bxraw_reprocessed.append(row['bxraw'])
        h5.close()

    bxraw_reprocessed_tot_orig_channel = [sum(x) for x in zip(*bxraw_reprocessed)]

#SCANNING LAST TRAIN

bcid = len(bxraw_reprocessed_tot_orig_channel) - 1

while bcid > 0 : 
    if bxraw_reprocessed_tot_orig_channel[bcid] > 100 and bxraw_reprocessed_tot_orig_channel[bcid+1]<0.1*bxraw_reprocessed_tot_orig_channel[bcid]:
        break
    else:
        bcid -= 1
print('BCID: '+str(bcid))
ratio = bxraw_reprocessed_tot_orig_channel[bcid+eb_num]/bxraw_reprocessed_tot_orig_channel[bcid]
print(ratio)
print("Ratios: "+ str(ratio))

old_albedo = 0.022410375592529844
new_albedo = ratio + old_albedo
print("New first empty bunch correction in % " + str(new_albedo*100))


#*******************************************************************************************





# --- PARAMETER ------------------
output_path = './'
#output_path = '/localdata/lfreitag/newChannels/'

outtablename = 'bcm1flumi'

# output data compression anc chunk size, normally not needed to be changed
compr_filter = t.Filters(complevel=9, complib='blosc')
chunkshape=(100,)


# lumi parameters
# channel mask counting from 1 (BRILDAQ channelid selection)
#channel_mask = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48]
channel_mask = [channel] #channel by channel analysis


# lumi calibration, parameters as in normtag
c0 = 0          #offset
c1 = 11245/139 #/141,139   #linear term, usually 11246/sigma_vis
c2 = 0    #quadratic term to correct non-linearity
calibtag = 'TestBeam'

# Use parameter to subtract a constant noise level. This value is subtracted
# from the bxraw before the albedo correction.
avg_noise = 0 

# Albedo correction parameters
do_albedo_correction = True
#str_channel_mask = str(channel_mask)
output_path = "Channel_"+str(sys.argv[2])+"_"


# albedo model starts with [1.0] and can be as long as 3564
# from 7921 

#albedo_model = [1.0, new_albedo , 0.0023920368925298427, 0.0007854522325298428, 0.00030464839252984286]

albedo_model = [1.0, new_albedo , 0.0023920368925298427, 0.0007854522325298428, 0.00030464839252984286, 0.00022096663252984283, 0.00018857369252984284, 0.00017816717252984283, 0.00017519799252984283, 0.00017183887252984284, 0.00016958514252984284, 0.00016651578252984285, 0.00016273452252984284, 0.00016219435252984283, 0.00015808399252984284, 0.00015572652252984285, 0.00015465688252984283, 0.00015297554252984285, 0.00015145875252984284, 0.00014926227252984284, 0.00014650772252984283, 0.00014439350252984284, 0.00014256191252984285, 0.00014015079252984282, 0.00013974297252984284, 0.00013766454252984284, 0.00013531781252984284, 0.00013311059252984282, 0.00013193722252984283, 0.00012988741252984283, 0.00012791989252984283, 0.00012498289252984283, 0.00012435329252984283, 0.00012467882252984285, 0.00012221046252984283, 0.00012008194852984284, 0.00012015706252984283, 0.00011647957252984284, 0.00011703765252984283, 0.00011527044252984283, 0.00011294159252984283, 0.00011131391752984283, 0.00011007974252984283, 0.00010775089252984283, 0.00010902800752984284, 0.00010670273252984284, 0.00010658110252984284, 0.00010395535252984283, 0.00010327923752984284, 0.00010127951252984283, 9.958028252984283e-05, 9.966256252984284e-05, 9.826024252984283e-05, 9.722282252984283e-05, 9.628556252984283e-05, 9.343085752984283e-05, 9.316971252984284e-05, 9.239701652984283e-05, 9.110560252984284e-05, 9.025419652984284e-05, 8.952084252984283e-05, 8.780015252984283e-05, 8.789316252984284e-05, 8.530318252984284e-05, 8.478447252984283e-05, 8.345012852984284e-05, 8.389729252984284e-05, 8.227677252984284e-05, 8.154699252984284e-05, 7.980483652984283e-05, 7.881391752984284e-05, 7.831667252984284e-05, 7.699307252984284e-05, 7.731144652984284e-05, 7.598426252984283e-05, 7.467854252984283e-05, 7.310809652984284e-05, 7.232465752984284e-05, 7.213506252984283e-05, 7.144106252984283e-05, 7.107975252984283e-05, 6.930897752984283e-05, 6.912296252984284e-05, 6.791025252984284e-05, 6.635054252984284e-05, 6.584614252984283e-05, 6.550629252984283e-05, 6.423992652984283e-05, 6.306299252984283e-05, 6.320250252984283e-05, 6.231174652984283e-05, 6.166783252984284e-05, 6.146035252984284e-05, 6.0769927529842835e-05, 5.9231682529842834e-05, 5.931396252984284e-05, 5.819783652984284e-05, 5.7747098529842835e-05, 5.764693252984284e-05, 5.5647212529842837e-05, 5.5386064529842835e-05, 5.537891252984284e-05, 5.3901482529842835e-05, 5.3701152529842834e-05, 5.3336267529842835e-05, 5.2105670529842835e-05, 5.2406167529842835e-05, 5.1533302529842834e-05, 5.134370252984284e-05, 5.022400252984284e-05, 4.963732652984284e-05, 4.9358292529842835e-05, 4.8646407529842834e-05, 4.743012252984284e-05, 4.753386552984284e-05, 4.641058852984284e-05, 4.6381968529842835e-05, 4.6160179529842834e-05, 4.4478836529842836e-05, 4.4049562529842834e-05, 4.3588088529842836e-05, 4.417119252984284e-05, 4.2547092529842835e-05, 4.2167894529842836e-05, 4.2067729529842835e-05, 4.1456007529842836e-05, 4.1348692529842836e-05, 4.047582652984283e-05, 3.9742479529842836e-05, 3.961727452984284e-05, 3.973532252984284e-05, 3.8708634529842836e-05, 3.821854452984283e-05, 3.8050412529842836e-05, 3.6848434529842836e-05, 3.735640952984284e-05, 3.632614452984284e-05, 3.657655752984283e-05, 3.600776652984284e-05, 3.573588952984283e-05, 3.500969852984284e-05, 3.4963192529842835e-05, 3.4476676529842835e-05, 3.356803952984283e-05, 3.302786952984284e-05, 3.261289952984284e-05, 3.3228198529842835e-05, 3.179369552984284e-05, 3.179727252984284e-05, 3.179011952984284e-05, 3.1593362529842836e-05, 3.0724079529842834e-05, 3.0055122529842835e-05, 3.0312689529842834e-05, 2.9246650529842834e-05, 2.9260964529842837e-05, 2.9160797529842834e-05, 2.8928269529842836e-05, 2.7998170529842836e-05, 2.7915894529842834e-05, 2.7694101529842835e-05, 2.7254092529842834e-05, 2.6942867529842834e-05, 2.6517165529842834e-05, 2.6703186529842836e-05, 2.5719426529842837e-05, 2.5633572529842837e-05, 2.5579909529842836e-05, 2.4900222529842835e-05, 2.5086242529842834e-05, 2.4642659529842837e-05, 2.4431596529842836e-05, 2.4174029529842834e-05, 2.3666052529842835e-05, 2.3319052529842836e-05, 2.3594506529842834e-05, 2.2660828529842837e-05, 2.2374642529842835e-05, 2.2768148529842837e-05, 2.2349602529842835e-05, 2.1745038529842836e-05, 2.1287142529842835e-05, 2.0947300529842834e-05, 2.1169091529842835e-05, 2.0246145529842835e-05, 2.0625340529842836e-05, 2.0911526529842835e-05, 2.0024352529842835e-05, 2.0206796529842836e-05, 1.9648736529842834e-05, 1.9777519529842836e-05, 1.9330356529842836e-05, 1.8836688529842835e-05, 1.9301738529842835e-05, 1.8629203529842835e-05, 1.8396678529842835e-05, 1.8260742529842837e-05, 1.8436028529842837e-05, 1.8074722529842834e-05, 1.7888702529842835e-05, 1.7759919529842837e-05, 1.7330643529842836e-05, 1.6887057529842834e-05, 1.6972912529842837e-05, 1.6633068529842836e-05, 1.6393389529842837e-05, 1.6543636529842836e-05, 1.6404121529842834e-05, 1.5996307529842836e-05, 1.5967689529842835e-05, 1.5810286529842834e-05, 1.5370278529842836e-05, 1.4966044529842833e-05, 1.4297087529842834e-05, 1.4851570529842834e-05, 1.5094827529842834e-05, 1.4454490529842835e-05, 1.4053832529842834e-05, 1.3917894529842833e-05, 1.3510080529842834e-05, 1.3832037529842834e-05, 1.3567317529842833e-05, 1.3592358529842835e-05, 1.3316907529842834e-05, 1.3023566529842834e-05, 1.2934135529842833e-05, 1.3141619529842834e-05, 1.2948444529842834e-05, 1.2440468029842834e-05, 1.2690878529842834e-05, 1.2250870529842833e-05, 1.2315261529842834e-05, 1.2197210029842834e-05, 1.2039808529842834e-05, 1.1703541529842833e-05, 1.1467440529842835e-05, 1.1481750529842835e-05, 1.1091823529842835e-05, 1.1002391529842834e-05, 1.1109709529842833e-05, 1.1284997529842834e-05, 1.0662546529842835e-05, 1.0591001529842834e-05, 1.0648238529842834e-05, 1.0408558529842835e-05, 1.0301240029842834e-05, 1.0215384529842834e-05, 1.0083024529842834e-05, 9.932777529842833e-06, 1.0108065529842834e-05, 9.696675529842834e-06, 9.764644529842834e-06, 9.778952529842833e-06, 9.346098529842834e-06, 9.578623529842834e-06, 8.777308029842834e-06, 9.464150529842834e-06, 9.027719529842834e-06, 9.192275529842834e-06, 8.662835529842834e-06, 8.741535529842834e-06, 8.830968529842834e-06, 8.365919029842833e-06, 8.244289529842834e-06, 8.519741529842833e-06, 8.215671529842835e-06, 7.961683529842834e-06, 7.936642029842834e-06, 7.779241529842834e-06, 7.671920529842834e-06, 7.975992529842833e-06, 7.675497529842834e-06, 7.450128529842834e-06, 7.4715925298428334e-06, 7.439396529842833e-06, 7.611107529842834e-06, 7.253377529842833e-06, 6.970770529842835e-06, 7.303459529842834e-06, 7.153212529842835e-06, 7.228336529842834e-06, 6.970770529842835e-06, 6.849141529842835e-06, 6.7489775298428336e-06, 6.731090929842834e-06, 6.641658029842834e-06, 6.541494029842834e-06, 6.566534529842834e-06, 6.466370229842834e-06, 6.434174529842834e-06, 6.058558229842834e-06, 6.276773729842834e-06, 6.208804929842834e-06, 6.087175929842834e-06, 5.987011929842834e-06, 5.665054529842834e-06, 5.715136529842834e-06, 5.690096029842834e-06, 5.718714529842834e-06, 5.482612529842834e-06, 5.389602129842834e-06, 5.464725929842834e-06, 5.421798229842834e-06, 5.357406529842834e-06, 5.335942829842834e-06, 5.157078029842834e-06, 5.078377129842834e-06, 5.221469529842834e-06, 5.192850529842834e-06, 4.981790229842834e-06, 5.146345929842834e-06, 4.738533129842834e-06, 4.591863929842834e-06, 4.581131829842834e-06, 4.652677529842834e-06, 4.584709529842834e-06, 4.731378529842834e-06, 4.688451529842834e-06, 4.767151529842834e-06, 4.266329529842834e-06, 4.162587829842834e-06, 4.3915349298428335e-06, 4.205515529842834e-06, 4.216247529842834e-06, 4.073154929842834e-06, 4.048114329842834e-06, 4.080309529842834e-06, 4.287792929842834e-06, 3.919331229842834e-06, 3.998032029842834e-06, 3.905022129842834e-06, 3.865671529842834e-06, 3.865671529842834e-06, 3.654610929842834e-06, 3.7583525298428337e-06, 3.876403529842834e-06, 3.6868065298428336e-06, 3.772662029842834e-06, 3.701115529842834e-06, 3.611682829842834e-06, 3.6152605298428336e-06, 3.493632229842834e-06, 3.432817929842834e-06, 3.3433855298428337e-06, 3.2825715298428343e-06, 3.207447829842834e-06, 3.143056529842834e-06, 3.3648491298428335e-06, 3.2718395298428337e-06, 3.089396829842834e-06, 3.0071195298428338e-06, 3.1394790298428336e-06, 3.014273929842834e-06, 3.0643561298428336e-06, 2.8604497298428342e-06, 2.989232829842834e-06, 2.878336329842834e-06, 2.753130729842834e-06, 2.8926454298428338e-06, 2.728089829842834e-06, 2.7960582298428344e-06, 2.5885749298428343e-06, 2.656543329842834e-06, 2.710203229842834e-06, 2.6171931298428343e-06, 2.745975929842834e-06, 2.5528017298428344e-06, 2.534915529842834e-06, 2.610038829842834e-06, 2.3560501298428342e-06, 2.3632048298428343e-06, 2.456214829842834e-06, 2.3882460298428345e-06, 2.3095453298428343e-06, 2.237999329842834e-06, 2.3274317298428344e-06, 2.4526375298428343e-06, 2.112793929842834e-06, 2.277349529842834e-06, 2.1271030298428344e-06, 2.1736077298428344e-06, 2.1271030298428344e-06, 2.1986488298428338e-06, 2.320277429842834e-06, 2.026938329842834e-06, 1.8373415298428344e-06, 2.1628759298428345e-06, 1.805145729842834e-06, 2.0734435298428344e-06, 1.912465029842834e-06, 1.633435229842834e-06, 1.765795329842834e-06, 2.0734435298428344e-06, 2.059134229842834e-06, 1.805145729842834e-06, 1.873114329842834e-06, 1.9053102298428344e-06, 1.7121358298428344e-06, 1.8874238298428343e-06, 1.855228029842834e-06, 1.6763629298428343e-06, 1.719290529842834e-06, 1.683517529842834e-06, 1.6799404298428342e-06, 1.6012395298428341e-06, 1.6227034298428342e-06, 1.5583120298428343e-06, 1.8087230298428341e-06, 1.6763629298428343e-06, 1.5046523298428344e-06, 1.4545703298428343e-06, 1.5726211298428343e-06, 1.461724829842834e-06, 1.4116425298428342e-06, 1.7157133298428343e-06, 1.5010750298428343e-06, 1.3508285298428343e-06, 1.4581473298428341e-06, 1.3293647298428342e-06, 1.2828597298428344e-06, 1.307900929842834e-06, 1.3615604298428341e-06, 1.4688795298428342e-06, 1.443838329842834e-06, 1.3937560298428342e-06, 1.3114781298428342e-06, 1.4474155298428342e-06, 1.3544055298428341e-06, 1.368714929842834e-06, 1.2828597298428344e-06, 1.096840129842834e-06, 1.1862725298428342e-06, 1.1576542298428342e-06, 1.2399320298428342e-06, 1.3472511298428343e-06, 1.014562229842834e-06, 1.2435095298428342e-06, 1.1934273298428342e-06, 1.096840129842834e-06, 1.2113137298428343e-06, 1.0252941298428341e-06, 1.114726729842834e-06, 1.028871329842834e-06, 1.0753763298428343e-06, 1.311478429842834e-06, 9.501707298428342e-07, 1.1254585298428343e-06, 9.394389298428341e-07, 1.0539125298428342e-06, 9.322842298428342e-07, 1.0074076298428341e-06, 7.820376298428341e-07, 8.714701298428342e-07, 1.0145620298428342e-06, 9.000884298428341e-07, 8.893565298428341e-07, 8.965112298428342e-07, 8.965112298428342e-07, 9.680571298428341e-07, 9.680571298428341e-07, 8.392744298428343e-07, 8.249652298428341e-07, 7.748830298428341e-07, 8.035014298428342e-07, 8.571610298428342e-07, 8.822019298428341e-07, 8.106559298428342e-07, 9.609025298428341e-07, 7.748830298428341e-07, 6.425227298428342e-07, 8.893565298428341e-07, 7.176461298428343e-07, 8.535836298428342e-07, 5.960179298428342e-07, 7.534192298428342e-07, 7.713056298428341e-07, 6.246361298428342e-07, 5.745540298428342e-07, 7.176461298428343e-07, 7.140688298428342e-07, 6.067497298428341e-07, 7.605738298428342e-07, 8.142333298428343e-07, 6.031725298428342e-07, 6.139043298428341e-07, 6.317908298428341e-07, 6.854503298428342e-07, 4.815442298428342e-07, 5.352037298428343e-07, 6.210590298428342e-07, 6.639866298428342e-07, 5.673995298428341e-07, 6.103271298428342e-07, 5.316264298428342e-07, 5.995951298428342e-07, 5.173172298428342e-07, 6.317909298428343e-07, 5.316264298428342e-07, 5.173172298428342e-07, 4.636577298428342e-07, 5.673994298428342e-07, 5.924405298428342e-07, 5.030081298428342e-07, 5.030081298428342e-07, 4.672349298428341e-07, 4.851216298428342e-07, 4.0284362984283416e-07, 5.530902298428341e-07, 4.457713298428341e-07, 5.566676298428341e-07, 5.030081298428342e-07, 5.101626298428341e-07, 5.280492298428342e-07, 4.636577298428342e-07, 3.778025298428342e-07, 5.459355298428342e-07, 4.672349298428341e-07, 4.922761298428343e-07, 4.171528298428341e-07, 3.921117298428341e-07, 3.9568892984283426e-07, 3.241430298428341e-07, 3.7064782984283406e-07, 4.064210298428342e-07, 4.565031298428342e-07, 4.3503922984283417e-07, 4.815442298428342e-07, 5.065853298428342e-07, 3.9568892984283426e-07, 4.386166298428342e-07, 3.8495712984283414e-07, 3.6707072984283406e-07, 3.7422512984283415e-07, 3.2772022984283427e-07, 3.813797298428341e-07, 3.778025298428342e-07, 3.3487492984283417e-07, 3.169883298428342e-07, 2.812154298428341e-07, 3.384523298428342e-07, 3.134112298428342e-07, 2.8479262984283426e-07, 3.8853442984283423e-07, 2.8479262984283426e-07, 3.3487482984283423e-07, 3.706479298428342e-07, 4.099981298428342e-07, 1.7031902984283418e-07, 3.3487482984283423e-07, 2.7048352984283406e-07, 2.669062298428342e-07, 2.525969298428341e-07, 2.8479262984283426e-07, 2.1324672984283413e-07, 3.456068298428342e-07, 3.5633872984283407e-07, 2.6332882984283416e-07, 2.955245298428341e-07, 2.3471042984283408e-07, 2.5617412984283425e-07, 1.9178282984283408e-07, 2.9194722984283423e-07, 3.241430298428341e-07, 2.812154298428341e-07, 2.8479282984283414e-07, 2.597516298428342e-07, 2.812154298428341e-07, 2.6332882984283416e-07, 2.3471052984283423e-07, 1.5600982984283425e-07, 2.311331298428342e-07, 1.9536012984283417e-07, 1.3096872984283427e-07, 3.456068298428342e-07, 3.098338298428342e-07, 2.490196298428342e-07, 1.3096872984283427e-07, 1.953602298428341e-07, 1.846282298428341e-07, 2.4544232984283414e-07, 2.1324672984283413e-07, 1.953602298428341e-07, 1.2381402984283415e-07, 2.490196298428342e-07, 2.418651298428342e-07, 1.9536012984283417e-07, 7.015462984283414e-08, 1.774735298428342e-07, 1.9893742984283426e-07, 1.667417298428341e-07, 1.846282298428341e-07, 1.667417298428341e-07, 1.1308222984283425e-07, 1.452779298428342e-07, 2.1682402984283421e-07, 1.3454612984283408e-07, 2.4544232984283414e-07, 1.5600982984283425e-07, 1.023503298428342e-07, 1.7031902984283418e-07, 9.877292984283417e-08, 8.804112984283426e-08, 9.519572984283423e-08, 1.1665962984283406e-07, 6.657726984283415e-08, 2.669062298428342e-07, 1.5243252984283416e-07, 9.519572984283423e-08, 1.3812322984283408e-07, 1.1665952984283412e-07, 8.088642984283415e-08, 1.846282298428341e-07, 2.418651298428342e-07, 1.1665952984283412e-07, 1.3454612984283408e-07, 1.953602298428341e-07, 1.5958722984283407e-07, 1.452779298428342e-07, 1.7031902984283418e-07, 1.5958722984283407e-07, 2.0251482984283407e-07, 1.3454612984283408e-07, 1.667417298428341e-07, 9.519572984283423e-08, 1.5600982984283425e-07, 1.023503298428342e-07, 7.730922984283421e-08, 1.1665962984283406e-07, 1.667417298428341e-07, 1.4170072984283426e-07, 1.8820562984283414e-07, 2.0251482984283407e-07, 1.0950492984283416e-07, 1.0950492984283416e-07, 4.1536129842834126e-08, 4.5113479842834184e-08, 4.1536129842834126e-08, 2.7226959842834198e-08, 5.9422679842834115e-08, 1.667417298428341e-07, 7.015462984283414e-08, 1.202368298428342e-07, 7.373192984283412e-08, 2.7226959842834198e-08, 1.3812332984283423e-07, 5.226812984283412e-08, 7.730922984283421e-08, 4.8690829842834136e-08, -1.391370157165833e-09, 1.667417298428341e-07, 3.4381629842834206e-08, 8.804112984283426e-08, 1.1308222984283425e-07, -6.936012015716579e-08, -8.546020157165874e-09, -2.6432570157165863e-08, -2.285527015716588e-08, 1.202368298428342e-07, 6.657726984283415e-08, -1.2123370157165826e-08, 1.3096872984283427e-07, 4.8690829842834136e-08, 1.202368298428342e-07, 2.7226959842834198e-08, 1.1665962984283406e-07, 1.202368298428342e-07, -9.440127015716585e-08, 6.299992984283413e-08, 2.7226959842834198e-08, 5.226812984283412e-08, 1.023503298428342e-07, 9.161842984283414e-08, 9.161842984283414e-08, 3.080442984283416e-08, -3.7164410157165805e-08, -1.391470157165878e-09, -4.7896330157165825e-08, 1.1665962984283406e-07, 1.738964298428342e-07, 9.877292984283417e-08, 6.657726984283415e-08, -1.927797015716579e-08, 9.161842984283414e-08, 5.7631698428341265e-09, -5.862827015716581e-08, 5.584542984283421e-08, 7.730922984283421e-08, -1.927797015716579e-08, 5.942272984283419e-08, -4.431907015716588e-08, 8.446372984283424e-08, 4.8690829842834136e-08, 7.015462984283414e-08, 2.1858298428342105e-09, 5.7631698428341265e-09, 8.088642984283415e-08, -4.074174015716579e-08, 5.584532984283416e-08, 1.1665962984283406e-07, 1.2917829842834204e-08, -3.000981015716584e-08, 2.364972984283415e-08, -4.968670157165816e-09, 4.5113479842834184e-08, 1.0235042984283413e-07, 1.6495099842834183e-08, 6.299992984283413e-08, 3.0804289842834184e-08, 1.5958712984283413e-07, 2.3649629842834212e-08, 3.0804289842834184e-08, 3.4381629842834206e-08, 4.1536129842834126e-08, 2.3649629842834212e-08, -8.546020157165874e-09, 3.795892984283419e-08, 6.657726984283415e-08, 7.015462984283414e-08, 4.8690829842834136e-08, 3.0804289842834184e-08, 4.1536129842834126e-08, 3.795892984283419e-08, 1.2023692984283415e-07, 9.519572984283423e-08, -2.2855210157165874e-08, -9.082391015716586e-08, -1.927797015716579e-08, -2.285527015716588e-08, -6.220553015716586e-08, -4.0741670157165854e-08, -7.29373701571658e-08, -1.927797015716579e-08, 1.7031902984283418e-07, -6.22055701571658e-08, -1.570067015716581e-08, 6.657726984283415e-08, -3.3587140157165825e-08, 4.5113479842834184e-08, 3.0804289842834184e-08, 2.364972984283415e-08, 1.3812332984283423e-07, -4.968670157165816e-09, 4.8690829842834136e-08, 1.6495099842834183e-08, 5.226812984283412e-08, -2.6432570157165863e-08, -1.3017427015716578e-07, 5.7631698428341265e-09, -3.3587140157165825e-08, 4.5113479842834184e-08, 7.015462984283414e-08, 4.8690829842834136e-08, -8.366932015716583e-08, 3.4381629842834206e-08, 2.7226959842834198e-08, 2.1858298428342105e-09, 5.584542984283421e-08, -1.570067015716581e-08, -5.8628200157165876e-08, -3.358707015716578e-08, -4.074174015716579e-08, 4.8690829842834136e-08, -4.7896330157165825e-08, -1.2123370157165826e-08, -1.2123370157165826e-08, 6.657726984283415e-08, 7.373192984283412e-08, -1.0155587015716582e-07, -3.000981015716584e-08, -8.366932015716583e-08, 3.795882984283414e-08, 8.446372984283424e-08, 1.2023692984283415e-07, -1.2123230157165848e-08, -4.968570157165876e-09, -1.2123230157165848e-08, 2.364972984283415e-08, -6.936012015716579e-08, 1.1308222984283425e-07, -4.074174015716579e-08, 1.1308222984283425e-07, -2.2855210157165874e-08, -8.546020157165874e-09, 5.7631698428341265e-09, -3.358707015716578e-08, -7.651472015716586e-08, 1.6495099842834183e-08, 5.9422679842834115e-08, -3.000981015716584e-08, -3.000981015716584e-08, -5.862827015716581e-08, 2.1858298428342105e-09, -8.546020157165874e-09, 1.2917829842834204e-08, 5.226812984283412e-08, 2.1858298428342105e-09, -4.4319010157165876e-08, -6.220553015716586e-08, 2.7226959842834198e-08, -6.936012015716579e-08, 5.7631698428341265e-09, 4.8690829842834136e-08, -6.578287015716588e-08, 2.0072329842834124e-08, -1.570067015716581e-08, -8.546020157165874e-09, 4.8690829842834136e-08, 2.3649629842834212e-08, 8.446372984283424e-08, 4.1536129842834126e-08, -1.927797015716579e-08, -4.7896330157165825e-08, -7.293747015716585e-08, 4.5113599842834196e-08, 1.5600982984283425e-07, 4.5113479842834184e-08, -7.651472015716586e-08, 3.438152984283416e-08, -1.5163807015716579e-07, 1.3096872984283427e-07, 1.023503298428342e-07, 7.015462984283414e-08, 9.340529842834115e-09, -1.5163807015716579e-07, -9.082397015716587e-08, -8.546020157165874e-09, -3.7164410157165805e-08, -5.505093015716579e-08, 5.7631698428341265e-09, -7.651472015716586e-08, 5.226812984283412e-08, -5.147367015716585e-08, -5.505093015716579e-08, -2.2855210157165874e-08, -1.570067015716581e-08, -5.505093015716579e-08, 5.7631698428341265e-09, 4.1536429842834155e-08, -2.2855170157165835e-08, -2.285527015716588e-08, 5.226812984283412e-08, 3.795892984283419e-08, 1.2917829842834204e-08, -9.082391015716586e-08, -1.1228770015716583e-07, -4.4319010157165876e-08, -8.009207015716581e-08, -3.7164410157165805e-08, -1.391370157165833e-09, -4.968670157165816e-09, -3.000981015716584e-08, 4.153626984283421e-08, -6.220553015716586e-08, 1.2917829842834204e-08, -5.505097015716583e-08, -1.0155587015716582e-07, -4.4319010157165876e-08, -2.6432570157165863e-08, -9.797857015716583e-08, 9.340499842834112e-09, 8.446372984283424e-08, 1.2917829842834204e-08, 1.2917829842834204e-08, -8.366932015716583e-08, -6.936012015716579e-08, -4.968670157165816e-09, -1.391370157165833e-09, -1.570067015716581e-08, -2.6432570157165863e-08, -1.265969701571658e-07, 3.0804289842834184e-08, -5.1473600157165805e-08, -1.2123370157165826e-08, 4.8690829842834136e-08, 1.6495099842834183e-08, 2.1858298428342105e-09, 1.2917829842834204e-08, 2.3649629842834212e-08, 9.340499842834112e-09, -5.147367015716585e-08, -1.051331701571658e-07, -2.6432570157165863e-08, -8.546020157165874e-09, 7.730922984283421e-08, -7.29373701571658e-08, -4.968570157165876e-09, -8.366932015716583e-08, 7.373192984283412e-08, -2.2855210157165874e-08, -8.724667015716589e-08, -2.2855210157165874e-08, -1.5163807015716579e-07, -6.578287015716588e-08, 4.5113479842834184e-08, -6.578287015716588e-08, -9.797857015716583e-08, -7.651467015716579e-08, 4.1536129842834126e-08, -1.2123370157165826e-08, -2.2855210157165874e-08, -4.968670157165816e-09, -1.391370157165833e-09, -1.0155587015716582e-07, -8.366932015716583e-08, 5.226812984283412e-08, -1.2123370157165826e-08, 3.0804289842834184e-08, -8.366932015716583e-08, 2.364972984283415e-08, 5.226812984283412e-08, 5.584542984283421e-08, 1.1308222984283425e-07, -3.358707015716578e-08, -4.4319010157165876e-08, 2.3649629842834212e-08, -1.391370157165833e-09, 8.088642984283415e-08, 9.87730298428341e-08, 5.942272984283419e-08, 4.5113479842834184e-08, 5.584542984283421e-08, 2.7226959842834198e-08, -3.000981015716584e-08, 5.7631698428341265e-09, 3.795892984283419e-08, 4.5113479842834184e-08, -5.147367015716585e-08, -7.293747015716585e-08, 3.0804289842834184e-08, -3.3587140157165825e-08, 5.584542984283421e-08, -3.7164410157165805e-08, -1.927797015716579e-08, 4.8690829842834136e-08, 3.795892984283419e-08, -1.2123370157165826e-08, -6.220553015716586e-08, -3.7164410157165805e-08, 2.3649629842834212e-08, 5.7631698428341265e-09, 3.438152984283416e-08, -4.074174015716579e-08, -2.285527015716588e-08, 5.7631698428341265e-09, 3.795892984283419e-08, -1.0155584015716581e-07, -1.927797015716579e-08, -1.4448347015716582e-07, 2.3649629842834212e-08, 3.0804289842834184e-08, -1.051331701571658e-07, -9.082397015716587e-08, -6.936012015716579e-08, -1.570067015716581e-08, -5.147367015716585e-08, 1.1308222984283425e-07, -3.3587140157165825e-08, -1.051331701571658e-07, -4.789627015716582e-08, 1.2917829842834204e-08, -4.0741670157165854e-08, -7.29373701571658e-08, -6.220553015716586e-08, -1.0871043015716585e-07, 1.2917829842834204e-08, -1.1228777015716587e-07, 2.364972984283415e-08, -4.4319010157165876e-08, 2.7226959842834198e-08, -3.3587140157165825e-08, 6.300005984283418e-08, -1.2301963015716589e-07, -5.862827015716581e-08, -4.7896330157165825e-08, -8.009207015716581e-08, 4.1536129842834126e-08, -8.366932015716583e-08, -9.082391015716586e-08, -1.2123370157165826e-08, 1.649502984283414e-08, 2.0072329842834124e-08, 9.340499842834112e-09, -1.570067015716581e-08, -1.2123370157165826e-08, -5.862827015716581e-08, -1.570067015716581e-08, -1.3912701571657878e-09, 9.340499842834112e-09, -8.009207015716581e-08, -2.6432570157165863e-08, -8.009207015716581e-08, -8.36693701571658e-08, 1.6495099842834183e-08, 2.1858298428342105e-09, -5.862827015716581e-08, -8.724667015716589e-08, -1.570057015716587e-08, -1.927797015716579e-08, -3.3587140157165825e-08, -4.7896330157165825e-08, -2.6432570157165863e-08, 9.161842984283414e-08, -8.724667015716589e-08, 5.584542984283421e-08, -8.546020157165874e-09, 6.657726984283415e-08, -3.7164410157165805e-08, 3.438152984283416e-08, -5.862827015716581e-08, -3.000981015716584e-08, -1.1228777015716587e-07, 1.6495099842834183e-08, 3.795892984283419e-08, -5.505093015716579e-08, -4.0741670157165854e-08, -1.1228770015716583e-07, -1.3375157015716587e-07, -3.7164410157165805e-08, -1.051331701571658e-07, -4.4319010157165876e-08, -4.074174015716579e-08, -9.082397015716587e-08, 8.804112984283426e-08, 2.007242984283417e-08, -5.147367015716585e-08, -4.4319010157165876e-08, 7.373192984283412e-08, 9.877292984283417e-08, 8.088642984283415e-08, 2.007242984283417e-08, 1.2917829842834204e-08, -9.440124015716585e-08, 3.0804289842834184e-08, 2.1858298428342105e-09, 3.4381629842834206e-08, -6.578287015716588e-08, -7.29373701571658e-08, -4.4319010157165876e-08, 2.3649629842834212e-08, -3.000981015716584e-08, -4.968670157165816e-09, 2.007242984283417e-08, -4.0741670157165854e-08, -2.6432570157165863e-08, 5.7631698428341265e-09, -4.0741670157165854e-08, -1.0871043015716585e-07, 5.584542984283421e-08, -4.7896330157165825e-08, -6.936012015716579e-08, -8.009207015716581e-08, -4.431907015716588e-08, 2.0072329842834124e-08, -1.570067015716581e-08, -8.546020157165874e-09, -2.6432570157165863e-08, -6.936012015716579e-08, -2.2855210157165874e-08, 5.7631698428341265e-09, 5.942272984283419e-08, 2.0072329842834124e-08, -2.285527015716588e-08, -4.7896330157165825e-08, 1.6495099842834183e-08, -1.9277870157165852e-08, -4.074174015716579e-08, 5.226812984283412e-08, -1.2301963015716589e-07, -1.1944237015716584e-07, -9.082397015716587e-08, 4.5113479842834184e-08, -3.7164410157165805e-08, -8.366932015716583e-08, 4.5113599842834196e-08, 1.6495099842834183e-08, 5.226812984283412e-08, -1.051331701571658e-07, 7.730922984283421e-08, -1.927797015716579e-08, -5.862827015716581e-08, -7.651472015716586e-08, 2.3649629842834212e-08, -6.936012015716579e-08, -4.7896330157165825e-08, -8.546020157165874e-09, -1.570057015716587e-08, -4.7896330157165825e-08, -1.927797015716579e-08, -1.480608001571658e-07, -3.3587140157165825e-08, -7.293747015716585e-08, -6.936012015716579e-08, -1.2123370157165826e-08, -1.0155587015716582e-07, -8.009207015716581e-08, -1.1586503015716581e-07, -4.968670157165816e-09, -2.6432570157165863e-08, -3.3587140157165825e-08, -4.4319010157165876e-08, 5.584532984283416e-08, -1.2123370157165826e-08, -2.285527015716588e-08, -4.968670157165816e-09, 9.340499842834112e-09, 2.3649629842834212e-08, -4.968670157165816e-09, -8.009207015716581e-08, -8.009197015716588e-08, 2.1858298428342105e-09, -4.968670157165816e-09, -1.1228777015716587e-07, -6.936012015716579e-08, -5.8628200157165876e-08, 5.226812984283412e-08, -5.862827015716581e-08, -4.4319010157165876e-08, -2.6432570157165863e-08, 6.300005984283418e-08, -5.147367015716585e-08, -6.578287015716588e-08, -3.7164410157165805e-08, 5.7631698428341265e-09, 7.730922984283421e-08, -9.797857015716583e-08, -1.570067015716581e-08, -9.082397015716587e-08, -1.1586503015716581e-07, 1.2917829842834204e-08, -6.22055701571658e-08, -9.082397015716587e-08, 5.7631698428341265e-09, 7.730922984283421e-08, 1.6495099842834183e-08, -8.724667015716589e-08, -1.570057015716587e-08, -3.00097701571658e-08, -3.358707015716578e-08, -7.293747015716585e-08, 1.2917829842834204e-08, -1.2123370157165826e-08, -1.1586503015716581e-07, 5.584542984283421e-08, -1.5163807015716579e-07, -5.862827015716581e-08, -7.29373701571658e-08, -4.431907015716588e-08, 9.340499842834112e-09, -9.797857015716583e-08, -3.358707015716578e-08, -1.8741111015716586e-07, -3.000981015716584e-08, 5.763289842834138e-09, -4.4319010157165876e-08, 1.649502984283414e-08, -6.578287015716588e-08, -5.147367015716585e-08, -1.391470157165878e-09, -2.2855210157165874e-08, -9.440124015716585e-08, 8.804112984283426e-08, 2.1859598428341527e-09, 4.5113479842834184e-08, -1.391370157165833e-09, -6.22055701571658e-08, 9.340499842834112e-09, 2.1858298428342105e-09, 2.1858298428342105e-09, -1.2301967015716582e-07, 9.340499842834112e-09, -4.4319010157165876e-08, -9.082397015716587e-08, -4.7896330157165825e-08, -1.0871043015716585e-07, -1.4448353015716583e-07, -7.29373701571658e-08, -3.358707015716578e-08, 4.1536129842834126e-08, -4.074174015716579e-08, -5.147367015716585e-08, 1.2917829842834204e-08, -6.936012015716579e-08, 9.340499842834112e-09, -6.578287015716588e-08, -5.505093015716579e-08, -3.00097701571658e-08, 2.3649629842834212e-08, -7.651472015716586e-08, -5.505093015716579e-08, -3.3587140157165825e-08, -1.1228770015716583e-07, -3.358707015716578e-08, 5.7631698428341265e-09, 5.7631698428341265e-09, -1.3732887015716585e-07, -9.797857015716583e-08, -4.7896330157165825e-08, -1.695245701571658e-07, -1.927797015716579e-08, -4.968670157165816e-09, -1.570067015716581e-08, -1.4090617015716584e-07, -8.546020157165874e-09, -1.2123370157165826e-08, -3.716437015716587e-08, -2.285527015716588e-08, 7.373192984283412e-08, -3.358707015716578e-08, -1.1228770015716583e-07, -5.862827015716581e-08, -3.3587140157165825e-08, -5.505093015716579e-08, 4.5113479842834184e-08, -1.570057015716587e-08, 1.0950492984283416e-07, -2.6432570157165863e-08, -1.927797015716579e-08, -1.0871043015716585e-07, -5.505093015716579e-08, 9.519572984283423e-08, -8.366932015716583e-08, -1.1944237015716584e-07, -1.0871043015716585e-07, -8.366932015716583e-08, -3.000981015716584e-08, 2.7226959842834198e-08, -4.074174015716579e-08, -4.968670157165816e-09, -9.797857015716583e-08, -4.7896330157165825e-08, -5.505093015716579e-08, -4.7896330157165825e-08, -3.7164410157165805e-08, -1.2123370157165826e-08, -1.051331701571658e-07, -1.2123370157165826e-08, 2.1859598428341527e-09, -6.936012015716579e-08, -2.0887491015716587e-07, 4.8690829842834136e-08, 2.1858298428342105e-09, 3.4381629842834206e-08, -9.797857015716583e-08, -4.7896330157165825e-08, -8.009207015716581e-08, -4.7896330157165825e-08, -6.936012015716579e-08, -1.570057015716587e-08, -8.546020157165874e-09, -5.862827015716581e-08, -1.731018701571658e-07, 2.007242984283417e-08, 7.015462984283414e-08, -1.2123370157165826e-08, -5.147367015716585e-08, -1.927797015716579e-08, -1.480608001571658e-07, 1.6495099842834183e-08, -4.431907015716588e-08, -1.570067015716581e-08, 1.2917829842834204e-08, -1.927797015716579e-08, -8.009197015716588e-08, 2.3649629842834212e-08, -1.927797015716579e-08, -2.6432570157165863e-08, -3.000981015716584e-08, -1.3732887015716585e-07, -7.651472015716586e-08, -7.651472015716586e-08, -4.968670157165816e-09, -3.358707015716578e-08, 2.1858298428342105e-09, -2.124521701571658e-07, -1.3017427015716578e-07, -4.4319010157165876e-08, 6.657726984283415e-08, -3.000981015716584e-08, -6.22055701571658e-08, -7.29373701571658e-08, -6.578287015716588e-08, -3.3587140157165825e-08, -1.3375157015716587e-07, -2.6432570157165863e-08, -4.074174015716579e-08, -1.6236994015716584e-07, 9.340499842834112e-09, -3.0009870157165845e-08, -3.7164410157165805e-08, -1.6594727015716582e-07, -9.797857015716583e-08, 2.7226959842834198e-08, -6.22055701571658e-08, -5.147367015716585e-08, -4.4319010157165876e-08, -6.936012015716579e-08, 1.6495099842834183e-08, -4.7896330157165825e-08, -8.366932015716583e-08, -7.29373701571658e-08, -5.1473600157165805e-08, 2.1858298428342105e-09, -6.936012015716579e-08, 1.6495099842834183e-08, 1.2917829842834204e-08, -3.716447015716581e-08, -2.2855210157165874e-08, -1.480608001571658e-07, -4.789627015716582e-08, -1.0871043015716585e-07, -1.0871043015716585e-07, -5.862827015716581e-08, 5.7631698428341265e-09, -4.074174015716579e-08, -1.391370157165833e-09, -1.3017427015716578e-07, 5.584542984283421e-08, -1.391470157165878e-09, -2.6432570157165863e-08, 2.1859598428341527e-09, -2.6432570157165863e-08, -5.862827015716581e-08, 1.6495099842834183e-08, -7.651477015716583e-08, 1.6495099842834183e-08, -2.285527015716588e-08, -8.36693701571658e-08, -9.440124015716585e-08, -1.0155587015716582e-07, -7.651477015716583e-08, -2.2855210157165874e-08, 7.373192984283412e-08, -4.7896330157165825e-08, -4.074174015716579e-08, -1.0871043015716585e-07, -7.651472015716586e-08, -6.22055701571658e-08, 4.1536129842834126e-08, -4.968670157165816e-09, -9.440127015716585e-08, -1.5879261015716585e-07, -2.6432570157165863e-08, -3.7164410157165805e-08, -1.927797015716579e-08, -1.0155587015716582e-07, 4.8690829842834136e-08, -3.000981015716584e-08, 1.2917829842834204e-08, -6.936012015716579e-08, 3.795892984283419e-08, -2.6432570157165863e-08, -7.651472015716586e-08, 1.2917829842834204e-08, -9.082397015716587e-08, 2.3649629842834212e-08, -3.7164410157165805e-08, -1.3375157015716587e-07, -1.2123370157165826e-08, -6.220553015716586e-08, 9.340499842834112e-09, -5.862827015716581e-08, -1.3017427015716578e-07, -5.505093015716579e-08, -1.5521537015716587e-07, -6.220553015716586e-08, -8.724667015716589e-08, -1.3732887015716585e-07, -1.3375157015716587e-07, -3.7164410157165805e-08, -8.546020157165874e-09, -4.4319010157165876e-08, -7.29373701571658e-08, -1.8025647015716586e-07, -1.391370157165833e-09, -8.724667015716589e-08, -4.431907015716588e-08, -6.22055701571658e-08, 5.584542984283421e-08, -5.505097015716583e-08, -9.082397015716587e-08, -1.265969701571658e-07, -1.1586503015716581e-07, -1.1586503015716581e-07, 2.3649629842834212e-08, -3.3587140157165825e-08, -9.797857015716583e-08, -7.651472015716586e-08, -4.7896330157165825e-08, -3.7164410157165805e-08, 4.153626984283421e-08, -6.220553015716586e-08, -3.7164410157165805e-08, -8.009207015716581e-08, 3.4381629842834206e-08, -1.265969701571658e-07, 2.007242984283417e-08, 3.0804289842834184e-08, 5.7631698428341265e-09, -9.797857015716583e-08, -1.4090617015716584e-07, -8.366932015716583e-08, -9.082397015716587e-08, -9.797857015716583e-08, -4.4319010157165876e-08, 2.1858298428342105e-09, -3.716447015716581e-08, -4.074174015716579e-08, -5.505093015716579e-08, -7.651477015716583e-08, -7.651472015716586e-08, -6.578287015716588e-08, -4.7896330157165825e-08, -1.0871043015716585e-07, -9.082397015716587e-08, -1.391470157165878e-09, 7.015462984283414e-08, -5.862827015716581e-08, 6.299992984283413e-08, -1.391370157165833e-09, -1.9814297015716588e-07, 3.795892984283419e-08, -1.0871043015716585e-07, -8.546020157165874e-09, -3.716447015716581e-08, -3.7164410157165805e-08, -7.651472015716586e-08, 3.0804289842834184e-08, -7.293747015716585e-08, -1.051331701571658e-07, -8.366932015716583e-08, -1.1586503015716581e-07, -8.724667015716589e-08, -7.29373701571658e-08, -3.000981015716584e-08, -5.1473600157165805e-08, -5.147367015716585e-08, -1.051331701571658e-07, -1.265969701571658e-07, -7.29373701571658e-08, -1.051331701571658e-07, -4.7896330157165825e-08, -3.7164410157165805e-08, -1.265969701571658e-07, -2.6432570157165863e-08, -3.000981015716584e-08, -1.480608001571658e-07, -1.6236997015716584e-07, 1.6495099842834183e-08, -3.358707015716578e-08, -6.220553015716586e-08, -8.009207015716581e-08, -1.194423001571658e-07, -4.968670157165816e-09, -5.505093015716579e-08, -1.1228770015716583e-07, 1.6495099842834183e-08, -3.000981015716584e-08, -4.0741670157165854e-08, 9.340499842834112e-09, -2.0172027015716586e-07, -3.358707015716578e-08, -1.4090621015716588e-07, -4.7896330157165825e-08, -5.147367015716585e-08, -1.1228770015716583e-07, -3.358707015716578e-08, -5.505093015716579e-08, -6.22055701571658e-08, -6.22055701571658e-08, 9.340499842834112e-09, -2.285527015716588e-08, -1.2123370157165826e-08, -3.7164410157165805e-08, 2.7226959842834198e-08, -9.797851015716583e-08, -5.505093015716579e-08, -7.651472015716586e-08, -6.936012015716579e-08, -6.220553015716586e-08, -4.968670157165816e-09, -7.651467015716579e-08, -1.480608001571658e-07, -1.1228770015716583e-07, 4.1536129842834126e-08, -3.7164410157165805e-08, -9.440124015716585e-08, -1.051331701571658e-07, -1.570067015716581e-08, -1.5163807015716579e-07, -6.936012015716579e-08, -1.6236994015716584e-07, 1.6495099842834183e-08, -4.7896330157165825e-08, -1.2123370157165826e-08, -5.147367015716585e-08, 5.7631698428341265e-09, -1.7667917015716588e-07, 5.226812984283412e-08, -1.0871043015716585e-07, -1.5163807015716579e-07, 2.7226959842834198e-08, -3.358707015716578e-08, -1.3017427015716578e-07, -1.3732887015716585e-07, -5.147367015716585e-08, -1.2301963015716589e-07, -1.2123370157165826e-08, -9.797857015716583e-08, -1.570057015716587e-08, -1.391370157165833e-09, -6.578287015716588e-08, -1.2123370157165826e-08, -5.8628200157165876e-08, 1.6495099842834183e-08, -5.1473600157165805e-08, -9.082397015716587e-08, -9.797857015716583e-08, -9.440124015716585e-08, -4.0741670157165854e-08, -4.968670157165816e-09, -1.8741111015716586e-07, 7.015462984283414e-08, -1.9277870157165852e-08, 2.1859598428341527e-09, 5.7631698428341265e-09, -1.570067015716581e-08, -6.22055701571658e-08, -1.927797015716579e-08, -1.0513322015716587e-07, 4.153626984283421e-08, 1.6495099842834183e-08, -9.440124015716585e-08, -1.1228777015716587e-07, -1.1586503015716581e-07, 5.226812984283412e-08, -5.505093015716579e-08, -1.0513311015716579e-07, -4.0741670157165854e-08, -3.00097701571658e-08, -1.2123370157165826e-08, -1.6236994015716584e-07, -1.391470157165878e-09, -1.0871043015716585e-07, -8.546020157165874e-09, -4.968670157165816e-09, -5.862827015716581e-08, -3.358707015716578e-08, -5.862827015716581e-08, -1.570067015716581e-08, -8.009207015716581e-08, -8.724667015716589e-08, -1.3732887015716585e-07, -3.7164410157165805e-08, -1.570067015716581e-08, -8.724667015716589e-08, 2.1858298428342105e-09, -7.651472015716586e-08, -1.1586503015716581e-07, -4.074174015716579e-08, -4.074174015716579e-08, -7.293747015716585e-08, -2.285527015716588e-08, -1.2301963015716589e-07, -1.3732882015716589e-07, -6.22055701571658e-08, 2.1858298428342105e-09, -1.927797015716579e-08, 1.2917729842834159e-08, -2.2855170157165835e-08, 2.1859598428341527e-09, -9.797857015716583e-08, -5.147367015716585e-08, -1.265969701571658e-07, -2.0172027015716586e-07, -1.3375157015716587e-07, -1.1586497015716581e-07, 1.2917829842834204e-08, -6.220553015716586e-08, -2.2855210157165874e-08, 2.3649629842834212e-08, -9.082397015716587e-08, -7.293747015716585e-08, -8.724667015716589e-08, -7.651472015716586e-08, 1.2917829842834204e-08, -8.546020157165874e-09, -6.220553015716586e-08, 2.3649629842834212e-08, -1.5879267015716586e-07, -1.5163807015716579e-07, -8.724667015716589e-08, -6.578287015716588e-08, 2.1858298428342105e-09, -1.8383377015716584e-07, -1.570067015716581e-08, 2.7226959842834198e-08, -4.0741670157165854e-08, 1.6495099842834183e-08, -1.0871043015716585e-07, -8.546020157165874e-09, -5.505093015716579e-08, 2.0072329842834124e-08, -4.7896330157165825e-08, -1.6236994015716584e-07, -3.000981015716584e-08, 8.088642984283415e-08, -5.1473600157165805e-08, 2.0072329842834124e-08, -6.22055701571658e-08, 4.8690829842834136e-08, 8.804112984283426e-08, -3.7164410157165805e-08, -1.051331701571658e-07, -2.160295001571658e-07, -4.4319010157165876e-08, 9.519572984283423e-08, -1.2123230157165848e-08, 4.153626984283421e-08, -1.570067015716581e-08, -8.366932015716583e-08, -3.358707015716578e-08, -2.6432570157165863e-08, -2.6432570157165863e-08, 5.226812984283412e-08, -1.4448347015716582e-07, -5.505093015716579e-08, -2.0887491015716587e-07, 1.6495099842834183e-08, 4.153626984283421e-08, -5.862827015716581e-08, -8.366932015716583e-08, -8.36693701571658e-08, -7.651472015716586e-08, -1.7667913015716584e-07, -1.1586503015716581e-07, -7.651472015716586e-08, 7.730922984283421e-08, -6.220553015716586e-08, -4.074174015716579e-08, 2.7226959842834198e-08, -9.082397015716587e-08, 2.1858298428342105e-09, -2.2855210157165874e-08, -4.4319010157165876e-08, -3.7164410157165805e-08, -3.0009870157165845e-08, -7.293747015716585e-08, -6.578287015716588e-08, -4.074174015716579e-08, -3.716447015716581e-08, -8.366932015716583e-08, 1.6495099842834183e-08, -3.7164410157165805e-08, -4.074174015716579e-08, -1.265969701571658e-07, -6.578287015716588e-08, -1.0513322015716587e-07, -5.862827015716581e-08, -4.968670157165816e-09, -6.578287015716588e-08, -1.2301963015716589e-07, -2.2855210157165874e-08, -1.981429201571658e-07, -8.009207015716581e-08, -2.6432570157165863e-08, -7.293747015716585e-08, -2.6432570157165863e-08, -4.7896330157165825e-08, -8.366932015716583e-08, 5.763289842834138e-09, -5.147367015716585e-08, -2.6432570157165863e-08, -8.724667015716589e-08, -9.440124015716585e-08, -8.366932015716583e-08, -1.0513322015716587e-07, -6.936012015716579e-08, -9.082397015716587e-08, -3.358703015716585e-08, -4.968670157165816e-09, -3.7164410157165805e-08, -6.936012015716579e-08, -3.358707015716578e-08, -3.7164410157165805e-08, -9.082397015716587e-08, -6.22055701571658e-08, 5.7631698428341265e-09, -8.546020157165874e-09, -4.7896330157165825e-08, -5.1473600157165805e-08, -8.36693701571658e-08, 9.340499842834112e-09, 5.7631698428341265e-09, -3.000981015716584e-08, 9.340499842834112e-09, 1.6495099842834183e-08, -5.862827015716581e-08, 1.2917829842834204e-08, -4.7896330157165825e-08, -4.074174015716579e-08, -2.6432570157165863e-08, -9.440124015716585e-08, -6.578287015716588e-08, -6.936012015716579e-08, -8.009207015716581e-08, -3.358707015716578e-08, -1.391370157165833e-09, -1.0871043015716585e-07, -4.074174015716579e-08, -2.285527015716588e-08, -5.505097015716583e-08, -3.3587140157165825e-08, -1.927797015716579e-08, -1.3017427015716578e-07, -7.29373701571658e-08, 9.340499842834112e-09, -6.936012015716579e-08, 5.7631698428341265e-09, 2.3649629842834212e-08, -2.2855210157165874e-08, -1.4448347015716582e-07, -5.505093015716579e-08, -4.789627015716582e-08, -2.124521701571658e-07, 2.7226959842834198e-08, -1.3732887015716585e-07, -3.000981015716584e-08, -5.147367015716585e-08, 9.340529842834115e-09, -3.716437015716587e-08, -7.29373701571658e-08, 2.7226959842834198e-08, 9.340499842834112e-09, -8.36693701571658e-08, -6.578287015716588e-08, -1.391370157165833e-09, -1.570057015716587e-08, 2.7226959842834198e-08, -3.358707015716578e-08, -2.2855210157165874e-08, -8.009197015716588e-08, -1.2123370157165826e-08, -8.724667015716589e-08, -7.651472015716586e-08, -1.9814297015716588e-07, -4.074174015716579e-08, -5.1473600157165805e-08, -6.22055701571658e-08, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -8.814074701571658e-07, -1.6594727015716582e-07, -1.570067015716581e-08, -1.3375157015716587e-07, -1.0155587015716582e-07, -4.431907015716588e-08, -7.29373701571658e-08]


calculate_albedo_every = 7 # in 4 nibbles (~1.4s), BRILDAQ processor it's 10 seconds
albedo_queue_length = 150 # number of histograms, in BRILDAQ processor it's 150
#noise calculation window, in units of BX (only active with albedo correction)
noise_calc_start = 3480  # BRILDAQ processor uses: 3480
noise_calc_end = 3530  # BRILDAQ processor uses: 3530



# --- START SCRIPT ----------------
fill = int(sys.argv[1])
if fill<5633:
	raise ValueError('Fill number too small, this script only works with 2017 and 2018 data')
elif fill<6540:
	year = 17
elif fill<7645:
	year = 18
elif fill<8533:
	year = 22
else:
	year = 23

class Lumitable(t.IsDescription):
	fillnum = t.UInt32Col(shape=(), dflt=0, pos=0)
	runnum = t.UInt32Col(shape=(), dflt=0, pos=1)
	lsnum = t.UInt32Col(shape=(), dflt=0, pos=2)
	nbnum = t.UInt32Col(shape=(), dflt=0, pos=3)
	timestampsec = t.UInt32Col(shape=(), dflt=0, pos=4)
	timestampmsec = t.UInt32Col(shape=(), dflt=0, pos=5)
	totsize = t.UInt32Col(shape=(), dflt=0, pos=6)
	publishnnb = t.UInt8Col(shape=(), dflt=0, pos=7)
	datasourceid = t.UInt8Col(shape=(), dflt=0, pos=8)
	algoid = t.UInt8Col(shape=(), dflt=0, pos=9)
	channelid = t.UInt8Col(shape=(), dflt=0, pos=10)
	payloadtype = t.UInt8Col(shape=(), dflt=0, pos=11)
	calibtag = t.StringCol(itemsize=32, shape=(), dflt='', pos=12)
	avgraw = t.Float32Col(shape=(), dflt=0.0, pos=13)
	avg = t.Float32Col(shape=(), dflt=0.0, pos=14)
	bxraw = t.Float32Col(shape=(3564,), dflt=0.0, pos=15)
	bx = t.Float32Col(shape=(3564,), dflt=0.0, pos=16)
	maskhigh = t.UInt32Col(shape=(), dflt=0, pos=17)
	masklow = t.UInt32Col(shape=(), dflt=0, pos=18)

albedo_model_full = py.zeros(3564)
albedo_model_full[1:len(albedo_model)] += albedo_model[1:]

output_path += str(year) + '_new'
if not os.path.exists(output_path):
	os.makedirs(output_path)
output_path += '/'+str(fill)+'/'
if not os.path.exists(output_path):
	os.makedirs(output_path)

input_path = '/brildata/'+str(year)+'/'+str(fill)+'/'
files = os.listdir(input_path)

    
# create data query condition
query = ''.join(['(channelid == '+str(ch)+ ') | ' for ch in channel_mask])
query = '('+query[:-3]+') & (algoid == 1)' # in 2017 some data was saved under algoid==2

    # get bunch mask from last file (likely the one with collisions)
h5 = t.open_file(input_path+files[-1],mode='r')
bxmask = h5.root.beam[0]['collidable']
h5.close()

    #prepare albedo queue
albedo_queue = Queue.Queue()
calc_counter = 0
albedo_fraction = py.ones(3564)
noise = 0

for file in files:
	print("============================================",file)
	    #input file
	h5in = t.open_file(input_path+file,mode='r')
	intable = h5in.root.bcm1fagghist

	    #output file
	h5out = t.open_file(output_path+file,mode='w')
	outtable = h5out.create_table('/',outtablename,Lumitable,filters=compr_filter,chunkshape=chunkshape)
	rownew = outtable.row


	lastnb = -1
	table_len = len(list(intable.where(query))) #if size ok for memory to make into list?
	for i, rowin in enumerate(intable.where(query)):
		    #if file == '8088_356718_2208032336_2208040054.hd5': print(lastnb,rowin['nbnum'])
		if lastnb == -1:
			lastrun = rowin['runnum']
			lastls = rowin['lsnum']
			lastnb = rowin['nbnum']
			lasttime = rowin['timestampsec']
			lasttimems = rowin['timestampmsec']
			chcount = 0
			agghist = py.zeros(3564)

		if lastnb != rowin['nbnum'] or i == table_len-1:
			    # process lumi now
			r0 = 1-(agghist/chcount/2**14)
			r0[r0<0] = 0
			bxraw = -py.log(r0)

#			    albedo correction every histogram
			    #for i,m in enumerate(bxmask):
			    #	if m:
			    #		bxraw -= bxraw[i]*py.roll(albedo_model_full,i)
			    #bxraw -= bxraw[noise_calc_start:noise_calc_end].mean()

#			    bxraw -= avg_noise

#			    bxraw -= bxraw[noise_calc_start:noise_calc_end].mean()

			    # albedo correction
			if do_albedo_correction:
				    # put data in albedo queue
				albedo_queue.put(bxraw)
				calc_counter +=1
				if calc_counter>calculate_albedo_every:
					calc_counter = 0
					    # average everything in albedo queue
					uncorrected = py.zeros(3564)
					queuesize = albedo_queue.qsize()
					for i in range(queuesize):
						tmp = albedo_queue.get()
						uncorrected +=tmp
						if albedo_queue.qsize() < albedo_queue_length:
							albedo_queue.put(tmp)
					uncorrected/=queuesize
					    # calculate albedo
					corrected = uncorrected.copy()
					for i,m in enumerate(bxmask):
						if m:
							corrected -= corrected[i]*py.roll(albedo_model_full,i)

					    # make fractions
					albedo_fraction[uncorrected!=0] = corrected[uncorrected!=0]/uncorrected[uncorrected!=0]

					    # noise to subtract
					noise = corrected[noise_calc_start:noise_calc_end].mean()

				bxraw = bxraw*albedo_fraction - noise




			    # calibrate and sum up for total
			bx = c1*bxraw + c2*bxraw**2 +c0
			avgraw = (bxmask * bxraw).sum() # needs channel mask
			avg = (bxmask * bx).sum() # needs channel mask

			    #write out data
			rownew['fillnum'] = fill
			rownew['runnum'] = lastrun
			rownew['lsnum'] = lastls
			rownew['nbnum'] = lastnb
			rownew['timestampsec'] = lasttime
			rownew['timestampmsec'] = lasttimems
			rownew['totsize'] =  28596 # probably wrong, but does anyone care?
			rownew['publishnnb'] =  4
			rownew['datasourceid'] = 14 # I think...
			rownew['algoid'] = 0 # I think...
			rownew['channelid'] = 0
			rownew['payloadtype'] = 11 # no idea why, or if correct
			rownew['calibtag'] = calibtag
			rownew['avgraw'] = avgraw
			rownew['avg'] = avg
			rownew['bxraw'] = bxraw
			rownew['bx'] = bx
			rownew['maskhigh'] = 0 # need to create this from channel mask
			rownew['masklow'] = 0 # need to create this from channel mask
			rownew.append()

			    #reinitialize
			lastrun = rowin['runnum']
			lastls = rowin['lsnum']
			lastnb = rowin['nbnum']
			lasttime = rowin['timestampsec']
			lasttimems = rowin['timestampmsec']
			chcount = 0
			agghist = py.zeros(3564)
			    #if file == '8088_356718_2208032336_2208040054.hd5': print("===",lastls,lastnb, rowin['nbnum'])

			if lastls % 100 ==0: print(lastrun, lastls)

		    #sum the agg hist and count the channels
		chcount += 1
		agghist += rowin['data']
		
	

	outtable.flush()
	h5in.close()
	h5out.close()